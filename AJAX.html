<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casa de Cambio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>

<body>

    <h1>Casa de Câmbio</h1>

    <select id="selectDe" class="form-select form-select-lg mb-3" aria-label="Large select example">
        <option selected>Escolha uma moeda</option>
    </select>

    <div class="input-group input-group-lg">
        <span class="input-group-text" id="inputGroup-sizing-lg">Valor</span> 
        <input type="number" class="form-control" step="0.1" aria-label="Sizing example input"
            aria-describedby="inputGroup-sizing-lg">
    </div> 

    <select id="selectPara" class="form-select form-select-lg mb-3" aria-label="Large select example">
        <option selected>Escolha uma moeda</option>
    </select>

    <button type="button" class="btn btn-primary btn-lg">Converter</button>

    <div class="input-group">
        <span class="input-group-text">Valor convertido</span>
        <textarea class="form-control" aria-label="With textarea"></textarea>
      </div>


    <script>

        buscarMoedas()

        var dataAtual = new Date();
        var dia = dataAtual.getDate();
        var mes = dataAtual.getMonth() + 1;
        var ano = dataAtual.getFullYear();

        var dataFormatada = dia + '-' + mes + '-' + ano;

        const btBuscarCep = document.getElementById("idBtBuscarCep")

        btBuscarCep.onclick = function () {
            buscarCEP(document.getElementById("idCep").value)
        }
 
        // request busca de moedas disponíveis e cria elas como uma option
        function buscarMoedas() {
            var xhr = new XMLHttpRequest();

            xhr.open("GET", "https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/Moedas?$top=100&$skip=0&$format=json&$select=simbolo,nomeFormatado,tipoMoeda");

            xhr.addEventListener("load", function () {
                let resposta = xhr.responseText;
                let enderecoOBJ = JSON.parse(resposta);

                let selectDe = document.getElementById("selectDe");
                let selectPara = document.getElementById("selectPara");

                for (const item of enderecoOBJ.value) {
                    let option = document.createElement("option");
                    option.textContent = item.nomeFormatado;
                    option.value = item.simbolo
                    selectDe.appendChild(option);
                    selectPara.appendChild(option.cloneNode(true));
                }
            });

            xhr.send();
        }

        let selectDe = document.getElementById("selectDe")
        let selectPara = document.getElementById("selectPara")

        // request das cotacoes da moeda de entrada
        selectDe.addEventListener('change', () => {
            let selectDe = document.getElementById("selectDe")
            let selectPara = document.getElementById("selectPara")

            var xhrEntrada = new XMLHttpRequest();

            xhrEntrada.open("GET", "https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/CotacaoMoedaDia(moeda=@moeda,dataCotacao=@dataCotacao)?@moeda='" + selectDe.value + "'&@dataCotacao='" + dataFormatada + "'&$top=100&$format=json&$select=cotacaoCompra,cotacaoVenda,tipoBoletim");

            xhrEntrada.addEventListener("load", function () {
                let resposta = xhrEntrada.responseText;
                let enderecoOBJ = JSON.parse(resposta);

                let indiceFechamento = enderecoOBJ.value[4]
                let cotacaoCompraEntrada = indiceFechamento.cotacaoCompra
                let cotacaoVendaEntrada = indiceFechamento.cotacaoVenda

            });

            xhrEntrada.send();

            // request das cotacoes da moeda de saida
            selectPara.addEventListener('change', () => {
                var xhrSaida = new XMLHttpRequest()

                xhrSaida.open("GET", "https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/CotacaoMoedaDia(moeda=@moeda,dataCotacao=@dataCotacao)?@moeda='" + selectPara.value + "'&@dataCotacao='" + dataFormatada + "'&$top=100&$format=json&$select=cotacaoCompra,cotacaoVenda,tipoBoletim");

                xhrSaida.addEventListener("load", function () {
                    let resposta = xhrSaida.responseText;
                    let enderecoOBJ = JSON.parse(resposta);

                    let indiceFechamento = enderecoOBJ.value[4]
                    let cotacaoCompraSaida = indiceFechamento.cotacaoCompra
                    let cotacaoVendaSaida = indiceFechamento.cotacaoVenda

                });

                xhrSaida.send();
            })

        })

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
</body>

</html>